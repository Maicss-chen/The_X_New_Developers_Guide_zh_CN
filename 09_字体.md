# 字体

(本章的介绍性文字改编自 http://www.x.org/releases/x11r7.7/doc/xorg-docs/fonts/fonts.html 的介绍)

如“X 客户端生态系统”一章所述，X 有两个字体系统，最初的核心 X11 字体系统和较新的 Xft 字体系统。

核心 X11字体系统直接来源于1987年 X11R1包含的字体系统，它只能使用单色位图字体。多年来，它或多或少地被迫处理可伸缩字体和旋转字形。

Xft 从一开始就被设计成对可伸缩字体具有良好支持。与核心字体系统不同，它支持反锯齿和亚像素光栅化等功能。更重要的是，它让应用程序可以完全控制字形的呈现方式，使精细排版和所见即所得显示成为可能。最后，它允许应用程序使用系统范围内未安装的字体来显示具有嵌入字体的文档。

Xft 与核心字体系统不兼容: 使用 Xft 需要对工具包进行相当广泛的更改，在某些情况下，还需要对应用程序进行大量更改。在 X.Org 继续维护核心字体系统的同时，我们鼓励客户端软件作者尽快切换到 Xft。

有关使用和配置 x 字体系统的更多信息，请参阅 http://www.x.org/releases/x11r7.7/doc/xorg-docs/fonts/fonts.html。该文件还包括一般计算机字体的背景材料和其他参考网站的链接，先阅读这些内容可能有助于理解以下各节。

## 核心字体系统

在最初的 X11字体机制中，X 客户机如果想以 Times New Roman 字体呈现12个点大小的文本，首先会调用 XLoadFont() 以使用 XLFD 字体名称“-adobe-times-medium-r-normal--12-120-75-75-p-64-iso8859-1”打开该字体。服务器打开该字体(使用 libXfont 中的例程)并返回与打开的字体相关联的 XID，然后应用程序将该 XID 存储在相关的 GC 中，以便以后进行绘图操作。如果找不到该字体，客户端可以使用 XListFonts ()请求一个可用字体列表——因为 XLFD 的报告为每个点的大小、样式变体(粗体、斜体、罗马、浓缩等)和支持的编码(iso8859-* 用于旧的文本编码，iso10646-1用于 Unicode)提供了一个单独的字体名称，大多数 X 服务器将返回一个长达数千个字体条目的列表，这可能需要很长时间才能通过低带宽的远程连接发送。

在绘制文本之前，许多客户端首先需要确定绘制时字符串的大小（例如，调整按钮的大小或对文本区域进行换行）。为此，客户端使用字符串和字体信息调用 XTextExtents()，X 服务器以简单的并排顺序排列文本并返回生成的边界框和大小信息。如果需要其他布局，例如泰语或阿拉伯语等语言的复杂布局，则客户端必须自己进行布局。为了将文本拟合到一个区域中，这可能涉及尝试字符串的不同子集的多次往返，从而增加了文本绘制操作的延迟。

实际上绘制文本是通过 XDrawString() 或 XDrawText() 调用完成的，它们再次重做并排布局。每个 XDrawString() 调用只能绘制一条水平的文本行，尽管沿该基线的字符可以单独旋转。文本是单色的，没有抗锯齿，使用从 GC 传递给调用的前景色和背景色以及字体选择。每次调用只能绘制单一字体的字符，文本来自单一编码，因此将 iso8859-1 中的英文文本与 big5-1 中的中文字符混合需要多次调用。XDrawText() 允许在一次调用中传递多个字符串，每个字符串都有不同的字体属性集。

每个接受文本字符串的调用都有多种变体，具体取决于文本字符串的编码方式，例如，对于 XDrawString() 实际上有：

|                 |                 |
| --------------- | --------------- |
| XDrawString     | 单字节文本       |
| XDrawString16   | 双字节文本       |
| XmbDrawString   | 多字节文本       |
| XwcDrawString   | 宽字符文本       |
| Xutf8DrawString | UTF-8 多字节文本 |

如果您不知道所有这些不同的文本编码类型是什么，您可以了解更多关于对文本进行编码的各种方法：

- [每个软件开发人员绝对、绝对必须了解 Unicode 和字符集（没有任何借口！）作者：Joel Spolsky](http://www.joelonsoftware.com/articles/Unicode.html)

- [维基百科分类：字符编码](https://en.wikipedia.org/wiki/Category:Character_encoding)

- [字体和编码：从高级排版到 Unicode 以及介于两者之间的一切作者：Yannis Haralambous](http://shop.oreilly.com/product/9780596102425.do) 出版商: O'Reilly Media ISBN 10: 0-596-10242-9

## 客户端字体

2000 年代初期设计并实施了一个新的字体系统，它与遗留的核心字体系统并排放置，允许旧客户端和新客户端一起运行。新的字体系统将大部分工作转移到客户端，减少了往返次数并降低了绘制字体所需的延迟。它还添加了对复杂文本布局的更好支持，利用渲染扩展中的 alpha 混合支持为文本渲染提供抗锯齿和 LCD 优化，并允许客户端使用文档或应用程序中可用的字体，无需先将它们安装在 X 服务器中，也无需使用 X 字体服务 (xfs) 来提供对它们的远程访问。

X.Org 为这个字体系统提供的 API 是 libXft，但通常它位于一堆文本处理和字体渲染技术的中间。客户使用他们的工具包提供的文本界面，或者像 Cairo 这样的通用高级渲染 API。那些使用 Pango 或 Qt 布局引擎，可能使用 HarfBuzz 引擎，来确定如何将字形彼此相邻放置以形成单词，并在必要时重塑它们以适应其上下文。这些 API 反过来使用 FontConfig 库为每个所需的字符集或字形查找可用字体，并使用 FreeType 库从各种格式的字体中光栅化图像，例如 OpenType、TrueType、PCF 或 Type1。然后 libXft 库将图像文本发送到 X 服务器，

常它位该系统允许客户端在本地计算布局，而无需往返服务器；沿着他们选择的任何基础绘制文本，而不仅仅是水平基线；并允许根据需要在客户端中插入对各种不同文本处理模型的支持，而无需修改 X 服务器或在可能具有特权的 X 服务器进程中运行代码。FontConfig 提供了一种更实用、更易读的字体命名方案，上面提到的 12 磅 Times New Roman 的长 XLFD 名称，而不是简单的“Times New Roman-12”。

新的字体渲染模型被现代应用程序和工具包（如 Gtk+ 和 Qt）广泛采用，同时保留了原有的 X11 核心字体子系统，以向后兼容尚未更新的旧 X11 应用程序。